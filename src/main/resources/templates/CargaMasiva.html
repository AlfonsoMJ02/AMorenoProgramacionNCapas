<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Carga Masiva</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>

    <body class="d-flex justify-content-center">

        <div class="text-center mt-4">

            <button id="btnMostrar"
                    class="btn btn-primary mb-3"
                    th:if="${archivoValido == null or !archivoValido}">
                Mostrar formulario
            </button>

            <div id="opciones" class="d-none mb-3">
                <button class="btn btn-secondary me-2" id="btnTxt">Cargar archivo TXT</button>
                <button class="btn btn-success" id="btnExcel">Cargar archivo Excel</button>
            </div>

            <div id="formularioArchivo" class="mt-3">
                <form id="formCarga" action="/Usuario/CargaMasiva" method="post" enctype="multipart/form-data">

                    <input type="file" id="fileInput" name="archivo"
                           class="form-control form-control-md mx-auto d-none"
                           style="max-width: 400px;">

                    <br>

                    <button type="submit" id="btnSubir"
                            class="btn btn-primary d-none">
                        Subir Archivo
                    </button>

                </form>
            </div>

            <div id="resultadoValidacion">

                <div th:if="${archivoValido}" class="mt-4">
                    <button class="btn btn-success">
                        Proceder con inserci칩n
                    </button>
                </div>

                <div th:if="${listaErrores != null}">
                    <table class="table table-bordered table-danger mt-3">
                        <thead>
                            <tr>
                                <th>Fila</th>
                                <th>Campo</th>
                                <th>Descripci칩n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="error : ${listaErrores}">
                                <td th:text="${error.fila}"></td>
                                <td th:text="${error.dato}"></td>
                                <td th:text="${error.descripcion}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>

        </div>


        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script>

            $(document).ready(function () {

                $("#btnMostrar").click(function () {

                    $("#btnMostrar").addClass("d-none");
                    $("#opciones").removeClass("d-none");

                    // Ocultar resultados anteriores
                    $("#resultadoValidacion").hide();
                });

                $("#btnTxt").click(function () {

                    $("#fileInput").attr("accept", ".txt").val("").removeClass("d-none");
                    $("#btnSubir").removeClass("d-none");
                });

                $("#btnExcel").click(function () {

                    $("#fileInput").attr("accept", ".xlsx").val("").removeClass("d-none");
                    $("#btnSubir").removeClass("d-none");
                });

                $("#formCarga").submit(function (e) {

                    let input = $("#fileInput")[0];

                    if (!input.files.length) {
                        e.preventDefault();
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Debes seleccionar un archivo'
                        });
                        return;
                    }

                    let nombreArchivo = input.files[0].name;
                    let extension = nombreArchivo.split('.').pop().toLowerCase();

                    if (extension !== "txt" && extension !== "xlsx") {
                        e.preventDefault();
                        Swal.fire({
                            icon: 'error',
                            title: 'Archivo no v치lido',
                            text: 'Solo se permiten archivos TXT o XLSX'
                        });
                        $("#fileInput").val("");
                    }
                });

            });

        </script>

        <script th:inline="javascript">
            /*<![CDATA[*/

            let archivoValido = /*[[${archivoValido}]]*/ false;
            let listaErrores = /*[[${listaErrores}]]*/ null;

            if (archivoValido === true) {

                Swal.fire({
                    icon: 'success',
                    title: 'Archivo v치lido',
                    text: 'El archivo fue validado correctamente.'
                });

            } else if (listaErrores !== null && listaErrores.length > 0) {

                Swal.fire({
                    icon: 'error',
                    title: 'Errores encontrados',
                    text: 'El archivo contiene errores. Revisa la tabla.'
                });
            }

            /*]]>*/
        </script>

    </body>
</html>